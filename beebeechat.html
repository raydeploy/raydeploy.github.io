<!doctypehtml><html lang="en"><meta charset="UTF-8"><meta name="viewport"content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible"content="ie=edge"><title>WebRTC Video Chat</title><style>#videoContainer{display:table;margin:0 auto}video{margin:10px;border:2px solid #000;width:90%;height:80%}#videoDiv{resize:both;overflow:auto}textarea{width:100%;height:150px;resize:none;box-sizing:border-box}.center{margin:auto;width:70%;border:3px solid green;padding:20px}button,input{width:100%;box-sizing:border-box}button{border:1px solid #000;background-color:#09f;color:#fff;padding:5px 10px}button:disabled,button[disabled]{border:1px solid #999;background-color:#ccc;color:#666}td,th{text-align:center}</style><div class="center"><button id="callButton"onclick="initiateCall()">Call</button> <button id="answerButton"onclick="createAndSendAnswer()">Answer</button> <button id="hangUpButton"onclick="disconnectRTCPeerConnection()">Hang Up</button><br><br><button id="switchCameraButton"onclick="switchCamera()">Switch Camera</button><br><br><input id="messageInput"size="80"placeholder="Enter message to send"> <button id="sendMessageButton"onclick="sendMessage()">Send Message</button><br><br><div id="videoContainer"><div id="videoDiv"draggable="true"><video id="localVideo"muted autoplay playsinline></video></div><br><div id="videoDiv"draggable="true"><video id="remoteVideo"autoplay playsinline></video></div></div><textarea readonly="readonly"id="chatTextArea"></textarea><br><br><textarea readonly="readonly"id="logs"></textarea><br><br></div><script>const webSocketConnection="wss://ws.x-r-c.com:8888/signaling?";let ws,localStream,rtcConnection,clientId=uuidv4(),dataChannel,cameraMode="user",existingTracks=[];const configuration={iceServers:[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}]};function disableAllButtons(){document.getElementById("callButton").disabled=!0,document.getElementById("answerButton").disabled=!0,document.getElementById("sendMessageButton").disabled=!0,document.getElementById("hangUpButton").disabled=!0}function sendMessage(){var e=document.getElementById("messageInput").value;dataChannel.send(JSON.stringify({message:e})),document.getElementById("chatTextArea").value+=e+"\n"}function disconnectRTCPeerConnection(){rtcConnection.close()}function getPipeId(){const e=new URLSearchParams(window.location.search);return e.get("pipe")}function initiateWebSocket(){ws=new WebSocket(webSocketConnection+getPipeId()),ws.onopen=function(e){log("WebSocket Connection Open."),initializeRtcConnection()},ws.onmessage=function(e){switch(jsonData=JSON.parse(e.data),jsonData.type){case"candidate":handleCandidate(jsonData.data,jsonData.id);break;case"offer":handleOffer(jsonData.data,jsonData.id);break;case"answer":handleAnswer(jsonData.data,jsonData.id)}},ws.onerror=function(e){console.error(e),log("WebSocket Connection Error.")},ws.onclose=function(e){log("WebSocket Connection Closed. Please Reload the page."),document.getElementById("callButton").disabled=!0,document.getElementById("answerButton").disabled=!0}}function log(e){document.getElementById("logs").value+=e+"\n"}function getLocalWebCamFeed(){constraints={audio:!0,video:{facingMode:cameraMode,width:{ideal:4096},height:{ideal:4096}}},navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(constraints).then(function(e){localStream=e;for(const n of(document.getElementById("localVideo").srcObject=e).getTracks())rtcConnection.addTrack(n,localStream)}).catch(function(e){log(e.name+": "+e.message)}):log("Camera Error: Incompatible Browser")}function initializeRtcConnection(){rtcConnection=new RTCPeerConnection(configuration),rtcConnection.ontrack=function(e){log("Recieved Remote Stream."),document.getElementById("remoteVideo").srcObject=e.streams[0]},rtcConnection.ondatachannel=function(e){log("Recieved a DataChannel."),dataChannel=e.channel,configureDateChannel(dataChannel),document.getElementById("sendMessageButton").disabled=!1},rtcConnection.onicecandidate=e=>{e.candidate&&(log("Sending Ice Candidate - "+e.candidate.candidate),ws.send(JSON.stringify({action:"onMessage",type:"candidate",data:e.candidate,id:clientId})))},rtcConnection.onconnectionstatechange=function(e){handleConnectionStateChange(e,rtcConnection.connectionState)},rtcConnection.oniceconnectionstatechange=function(e){handleConnectionStateChange(e,rtcConnection.iceConnectionState)},log("Web RTC Peer Connection Created."),document.getElementById("callButton").disabled=!1}function handleConnectionStateChange(e,n){switch(console.log("webrtc peer connection: "+n),n){case"connected":log("Web RTC Peer Connection Connected."),document.getElementById("answerButton").disabled=!0,document.getElementById("callButton").disabled=!0,document.getElementById("hangUpButton").disabled=!1,document.getElementById("sendMessageButton").disabled=!1;break;case"disconnected":log("Web RTC Peer Connection Disconnected. Please reload the page to reconnect."),disableAllButtons();break;case"failed":log("Web RTC Peer Connection Failed. Please reload the page to reconnect."),console.log(e),disableAllButtons();break;case"closed":log("Web RTC Peer Connection Closed. Please reload the page to reconnect."),disableAllButtons()}}function initiateCall(){dataChannel&&dataChannel.close(),dataChannel=rtcConnection.createDataChannel("channel",{}),configureDateChannel(dataChannel),rtcConnection.createOffer().then(e=>{log("Sending webRTC offer"),ws.send(JSON.stringify({action:"onMessage",type:"offer",data:e,id:clientId})),rtcConnection.setLocalDescription(e)},e=>{log("Error when creating an offer."),console.error(e)})}function createAndSendAnswer(){rtcConnection.createAnswer().then(e=>{log("Sent The Answer."),rtcConnection.setLocalDescription(e),ws.send(JSON.stringify({action:"onMessage",type:"answer",data:e,id:clientId}))},e=>{log("Error when creating an answer."),console.error(e)})}function handleCandidate(e,n){clientId!=n&&(log("Adding Ice Candidate - "+e.candidate),rtcConnection.addIceCandidate(new RTCIceCandidate(e)))}function handleOffer(e,n){clientId!=n&&(log("Recieved The Offer."),rtcConnection.setRemoteDescription(new RTCSessionDescription(e)),document.getElementById("answerButton").disabled=!1,document.getElementById("callButton").disabled=!0)}function handleAnswer(e,n){clientId!=n&&(log("Recieved The Answer"),rtcConnection.setRemoteDescription(new RTCSessionDescription(e)))}function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})}function configureDateChannel(e){e.onmessage=function(e){e=JSON.parse(e.data);document.getElementById("chatTextArea").value+=e.message+"\n"},e.onerror=function(e){log("DataChannel Error."),console.error(e)},e.onclose=function(e){log("DataChannel Closed."),disableAllButtons()}}function switchCamera(){cameraMode="user"==cameraMode?"environment":"user",getLocalWebCamFeed()}disableAllButtons(),getLocalWebCamFeed(),initiateWebSocket()</script>